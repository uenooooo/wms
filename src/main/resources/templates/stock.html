<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>在庫一覧</title>

    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 6px 8px;
            text-align: left;
        }

        th {
            background-color: #f0f0f0;
        }

        td.num {
            text-align: right;
        }

        .title-area {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .content-area {
            display: flex;
            gap: 16px;
        }

        .table-area {
            flex: 1;
        }

        .action-area {
            min-width: 200px;
            border: 1px solid #ccc;
            padding: 12px;
        }

        tr.clickable {
            cursor: pointer;
        }

        tr.clickable:hover {
            background-color: #f5f5f5;
        }

        .input-area {
            margin-top: 12px;
        }

        .input-area div {
            margin-bottom: 8px;
        }
    </style>
</head>

<body>

    <div class="title-area">
        在庫一覧
    </div>

    <div class="content-area">
        <!-- 操作 -->
        <div class="action-area">
            <div class="input-area">
                <div>
                    入荷数量
                    <input type="number" id="receiveQty" min="1">
                    <button type="button" onclick="submitReceive()">入荷確定</button>
                </div>
            </div>

            <div class="input-area">
                <div>
                    出荷数量
                    <input type="number" id="shipQty" min="1">
                    <button type="button" onclick="submitShip()">出荷確定</button>
                </div>
            </div>
        </div>

        <!-- 一覧 -->
        <div class="table-area">
            <table>
                <thead>
                    <tr>
                        <th></th>
                        <th>商品コード</th>
                        <th>商品名</th>
                        <th>在庫数</th>
                        <th>単価</th>
                        <th>作成日時</th>
                        <th>更新日時</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="row : ${stockList}" class="clickable"
                        th:onclick="|this.querySelector('input').click()|">
                        <td>
                            <input type="checkbox" name="productId" th:value="${row.productId}">
                        </td>
                        <td th:text="${row.productCd}"></td>
                        <td th:text="${row.productName}"></td>
                        <td class="num" th:text="${row.stockQty}"></td>
                        <td class="num" th:text="${row.price}"></td>
                        <td th:text="${#dates.format(row.creTime, 'yyyy-MM-dd HH:mm:ss')}"></td>
                        <td th:text="${#dates.format(row.updTime, 'yyyy-MM-dd HH:mm:ss')}"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 入荷フォーム -->
    <form id="receiveForm" method="post" th:action="@{/receive}" style="display:none;">
        <input type="hidden" name="productId" id="formProductId">
        <input type="hidden" name="quantity" id="formQuantity">
    </form>

    <!-- 出荷フォーム -->
    <form id="shipForm" method="post" th:action="@{/ship}" style="display:none;">
        <input type="hidden" name="productId" id="formShipProductId">
        <input type="hidden" name="quantity" id="formShipQuantity">
    </form>

    <script>
        function getCheckedProduct() {
            const checked = document.querySelectorAll('input[name="productId"]:checked');
            if (checked.length !== 1) {
                alert('商品を1件選択してください');
                return null;
            }
            return checked[0];
        }

        function submitReceive() {
            const product = getCheckedProduct();
            if (!product) return;

            const qty = document.getElementById('receiveQty').value;
            if (!qty || qty <= 0) {
                alert('数量を入力してください');
                return;
            }

            document.getElementById('formProductId').value = product.value;
            document.getElementById('formQuantity').value = qty;
            document.getElementById('receiveForm').submit();
        }

        function submitShip() {
            const product = getCheckedProduct();
            if (!product) return;

            const qty = parseInt(document.getElementById('shipQty').value);
            if (!qty || qty <= 0) {
                alert('数量を入力してください');
                return;
            }

            const stock = parseInt(product.closest('tr').querySelector('.num').innerText);
            if (qty > stock) {
                alert('在庫が足りません');
                return;
            }

            document.getElementById('formShipProductId').value = product.value;
            document.getElementById('formShipQuantity').value = qty;
            document.getElementById('shipForm').submit();
        }
    </script>

</body>
</html>
