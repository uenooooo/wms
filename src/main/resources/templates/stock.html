<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>在庫一覧</title>

	<style>
		table {
			border-collapse: collapse;
			width: 100%;
			table-layout: fixed;
		}

		th,
		td {
			border: 1px solid #ccc;
			padding: 6px 8px;
			text-align: left;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		th {
			background-color: #f0f0f0;
		}

		td.num {
			text-align: right;
		}

		th.product-cd,
		td.product-cd {
			width: 15%;
		}

		th.product-name,
		td.product-name {
			width: 30%;
		}

		th.stockQty,
		td.stockQty {
			width: 7%;
		}

		th.price,
		td.price {
			width: 7%;
		}

		th.creTime,
		td.creTime {
			width: 17.5%;
		}

		th.updTime,
		td.updTime {
			width: 17.5%;
		}

		.title-area {
			font-size: 20px;
			font-weight: bold;
			margin-bottom: 8px;
		}

		.content-area {
			display: flex;
			gap: 16px;
		}

		.table-area {
			flex: 1;
		}

		.action-area {
			min-width: 260px;
			border: 1px solid #ccc;
			padding: 12px;
		}

		.input-area {
			margin-top: 12px;
		}

		.form-row {
			display: flex;
			align-items: center;
			margin-bottom: 8px;
		}

		.form-row label {
			width: 80px;
			text-align: right;
			margin-right: 8px;
			font-size: 13px;
		}

		.form-row input {
			width: 140px;
			box-sizing: border-box;
		}

		.product-form {
			margin-top: 24px;
			border-top: 1px solid #ccc;
			padding-top: 12px;
		}

		.form-footer {
			margin-top: 12px;
			display: flex;
			justify-content: flex-end;
		}

		.error-message {
			color: red;
			font-weight: bold;
			margin-bottom: 8px;
		}

		tr.selected {
			background-color: #d0e7ff;
		}

		tr.clickable:hover {
			background-color: #f0f8ff;
			cursor: pointer;
		}
	</style>
</head>

<body>

	<div class="title-area">在庫一覧</div>

	<div class="content-area">
		<div class="action-area">
			<h4 style="margin:1px 0 4px 0;">入荷・出荷</h4>
			<div style="margin-bottom:16px; font-size:14px;">
				※ 一覧の行をクリックして編集
			</div>
			<div class="input-area">
				<div class="form-row">
					<label>入荷数量</label>
					<input type="number" id="receiveQty" min="1">
				</div>
				<div class="form-footer">
					<button type="button" onclick="submitReceive()">入荷確定</button>
				</div>
			</div>

			<div class="input-area">
				<div class="form-row">
					<label>出荷数量</label>
					<input type="number" id="shipQty" min="1">
				</div>
				<div class="form-footer">
					<button type="button" onclick="submitShip()">出荷確定</button>
				</div>
			</div>

			<!-- 商品マスタ編集 -->
			<div class="product-form">
				<h4 style="margin-bottom:4px;">商品マスタ編集</h4>
				<div style="margin-bottom:16px; font-size:14px;">
					※ 一覧の行をクリックして編集
				</div>

				<div th:if="${editErrorMessage}" class="error-message">
					<p th:text="${editErrorMessage}"></p>
				</div>

				<form method="post" th:action="@{/product/edit}">
					<input type="hidden" name="productId" id="editProductId">
					<div class="form-row">
						<label>商品コード</label>
						<input type="text" name="productCd" id="editProductCd" required maxlength="50">
					</div>
					<div class="form-row">
						<label>商品名</label>
						<input type="text" name="productName" id="editProductName" required maxlength="200">
					</div>
					<div class="form-row">
						<label>単価</label>
						<input type="number" name="price" id="editPrice" min="0">
					</div>
					<div class="form-footer">
						<button type="submit">更新</button>
					</div>
				</form>
			</div>

			<!-- 商品マスタ登録 -->
			<div class="product-form">
				<h4>商品マスタ登録</h4>

				<div th:if="${addErrorMessage}" class="error-message">
					<p th:text="${addErrorMessage}"></p>
				</div>

				<form method="post" th:action="@{/product/add}">
					<div class="form-row">
						<label>商品コード</label>
						<input type="text" name="productCd" required maxlength="50">
					</div>
					<div class="form-row">
						<label>商品名</label>
						<input type="text" name="productName" required maxlength="200">
					</div>
					<div class="form-row">
						<label>単価</label>
						<input type="number" name="price" min="0">
					</div>
					<div class="form-footer">
						<button type="submit">登録</button>
					</div>
				</form>
			</div>
		</div>

		<div class="table-area">
			<table>
				<thead>
					<tr>
						<th class="product-cd" title="商品コード">商品コード</th>
						<th class="product-name" title="商品名">商品名</th>
						<th class="stockQty" title="在庫数">在庫数</th>
						<th class="price" title="単価">単価</th>
						<th class="creTime" title="作成日時">作成日時</th>
						<th class="updTime" title="更新日時">更新日時</th>
					</tr>
				</thead>
				<tbody>
					<tr th:each="row : ${stockList}" class="clickable" th:data-product-id="${row.productId}"
						onclick="selectProduct(this)">
						<td class="product-cd" th:text="${row.productCd}" th:title="${row.productCd}"></td>
						<td class="product-name" th:text="${row.productName}" th:title="${row.productName}"></td>
						<td class="num" th:text="${row.stockQty}" th:title="${row.stockQty}"></td>
						<td class="num" th:text="${row.price}" th:title="${row.price}"></td>
						<td th:text="${#dates.format(row.creTime, 'yyyy-MM-dd HH:mm:ss')}"
							th:title="${#dates.format(row.creTime, 'yyyy-MM-dd HH:mm:ss')}"></td>
						<td th:text="${#dates.format(row.updTime, 'yyyy-MM-dd HH:mm:ss')}"
							th:title="${#dates.format(row.updTime, 'yyyy-MM-dd HH:mm:ss')}"></td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>

	<script>
		let selectedRow = null;

		function selectProduct(row) {
			if (selectedRow === row) {
				row.classList.remove('selected');
				selectedRow = null;
				editProductId.value = '';
				editProductCd.value = '';
				editProductName.value = '';
				editPrice.value = '';
				return;
			}

			document.querySelectorAll('tr.selected').forEach(r => r.classList.remove('selected'));

			row.classList.add('selected');
			selectedRow = row;

			editProductId.value = row.dataset.productId;
			editProductCd.value = row.cells[0].innerText;
			editProductName.value = row.cells[1].innerText;
			editPrice.value = row.cells[3].innerText;
		}

		function getSelectedProductRow() {
			if (!selectedRow) {
				alert('商品を1件選択してください');
				return null;
			}
			return selectedRow;
		}

		function submitReceive() {
			const row = getSelectedProductRow();
			if (!row) return;

			const qty = parseInt(document.getElementById('receiveQty').value);
			if (!qty || qty <= 0) {
				alert('数量を入力してください');
				return;
			}

			// フォーム送信処理（例）
			const productId = row.dataset.productId;
			const form = document.createElement('form');
			form.method = 'post';
			form.action = '/receive';
			const inputId = document.createElement('input');
			inputId.type = 'hidden';
			inputId.name = 'productId';
			inputId.value = productId;
			form.appendChild(inputId);
			const inputQty = document.createElement('input');
			inputQty.type = 'hidden';
			inputQty.name = 'quantity';
			inputQty.value = qty;
			form.appendChild(inputQty);
			document.body.appendChild(form);
			form.submit();
		}

		function submitShip() {
			const row = getSelectedProductRow();
			if (!row) return;

			const qty = parseInt(document.getElementById('shipQty').value);
			if (!qty || qty <= 0) {
				alert('数量を入力してください');
				return;
			}

			const stock = parseInt(row.querySelector('.num').innerText);
			if (qty > stock) {
				alert('在庫が足りません');
				return;
			}

			// フォーム送信処理（例）
			const productId = row.dataset.productId;
			const form = document.createElement('form');
			form.method = 'post';
			form.action = '/ship';
			const inputId = document.createElement('input');
			inputId.type = 'hidden';
			inputId.name = 'productId';
			inputId.value = productId;
			form.appendChild(inputId);
			const inputQty = document.createElement('input');
			inputQty.type = 'hidden';
			inputQty.name = 'quantity';
			inputQty.value = qty;
			form.appendChild(inputQty);
			document.body.appendChild(form);
			form.submit();
		}
	</script>
</body>

</html>
