<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>在庫一覧</title>

	<style>
		table {
			border-collapse: collapse;
			width: 100%;
		}

		th,
		td {
			border: 1px solid #ccc;
			padding: 6px 8px;
			text-align: left;
		}

		th {
			background-color: #f0f0f0;
		}

		td.num {
			text-align: right;
		}

		.title-area {
			font-size: 20px;
			font-weight: bold;
			margin-bottom: 8px;
		}

		.content-area {
			display: flex;
			gap: 16px;
		}

		.table-area {
			flex: 1;
		}

		.action-area {
			min-width: 200px;
			border: 1px solid #ccc;
			padding: 12px;
		}

		tr.clickable {
			cursor: pointer;
		}

		tr.clickable:hover {
			background-color: #f5f5f5;
		}

		.input-area {
			margin-top: 12px;
		}

		.input-area div {
			margin-bottom: 8px;
		}

		.product-form {
			margin-top: 24px;
			border-top: 1px solid #ccc;
			padding-top: 12px;
		}
	</style>
</head>

<body>

	<div class="title-area">
		在庫一覧
	</div>

	<div class="content-area">
		<!-- 操作 -->
		<div class="action-area">
			<div class="input-area">
				<div>
					入荷数量
					<input type="number" id="receiveQty" min="1">
					<button type="button" onclick="submitReceive()">入荷確定</button>
				</div>
			</div>

			<div class="input-area">
				<div>
					出荷数量
					<input type="number" id="shipQty" min="1">
					<button type="button" onclick="submitShip()">出荷確定</button>
				</div>
			</div>

			<!-- 商品マスタ登録 -->
			<div class="product-form">
				<h4>商品マスタ登録</h4>
				<form method="post" th:action="@{/product/add}">
					<div>
						商品コード
						<input type="text" name="productCd" required
							   pattern="^[\x20-\x7E]+$"
							   title="商品コードは半角文字のみで入力してください">
					</div>
					<div>
						商品名
						<input type="text" name="productName" required>
					</div>
					<div>
						単価（円）
						<input type="number" name="price" min="0">
					</div>
					<div>
						<button type="submit">登録</button>
					</div>
				</form>
			</div>

			<!-- 商品マスタ編集 -->
			<div class="product-form">
				<h4>商品マスタ編集</h4>
				<form method="post" th:action="@{/product/update}">
					<input type="hidden" name="productId" id="editProductId">

					<div>
						商品コード
						<input type="text" name="productCd" id="editProductCd" required>
					</div>
					<div>
						商品名
						<input type="text" name="productName" id="editProductName" required>
					</div>
					<div>
						単価（円）
						<input type="number" name="price" id="editPrice" min="0">
					</div>
					<div>
						<button type="submit">更新</button>
					</div>
				</form>
				<div style="margin-top:4px;font-size:12px;">
					※ 一覧から商品を1件選択すると編集できます
				</div>
			</div>
		</div>

		<!-- 一覧 -->
		<div class="table-area">
			<table>
				<thead>
					<tr>
						<th></th>
						<th>商品コード</th>
						<th>商品名</th>
						<th>在庫数</th>
						<th>単価</th>
						<th>作成日時</th>
						<th>更新日時</th>
					</tr>
				</thead>
				<tbody>
					<tr th:each="row : ${stockList}" class="clickable"
						th:onclick="|selectProduct(this)|">
						<td>
							<input type="checkbox" name="productId" th:value="${row.productId}">
						</td>
						<td th:text="${row.productCd}"></td>
						<td th:text="${row.productName}"></td>
						<td class="num" th:text="${row.stockQty}"></td>
						<td class="num" th:text="${row.price}"></td>
						<td th:text="${#dates.format(row.creTime, 'yyyy-MM-dd HH:mm:ss')}"></td>
						<td th:text="${#dates.format(row.updTime, 'yyyy-MM-dd HH:mm:ss')}"></td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>

	<!-- 入荷フォーム -->
	<form id="receiveForm" method="post" th:action="@{/receive}" style="display:none;">
		<input type="hidden" name="productId" id="formProductId">
		<input type="hidden" name="quantity" id="formQuantity">
	</form>

	<!-- 出荷フォーム -->
	<form id="shipForm" method="post" th:action="@{/ship}" style="display:none;">
		<input type="hidden" name="productId" id="formShipProductId">
		<input type="hidden" name="quantity" id="formShipQuantity">
	</form>

	<script>
		function getCheckedProduct() {
			const checked = document.querySelectorAll('input[name="productId"]:checked');
			if (checked.length !== 1) {
				alert('商品を1件選択してください');
				return null;
			}
			return checked[0];
		}

		function selectProduct(row) {
			const checkbox = row.querySelector('input[name="productId"]');

			// すでに選択中 → 解除
			if (checkbox.checked) {
				checkbox.checked = false;

				// 編集フォームをクリア
				document.getElementById('editProductId').value = '';
				document.getElementById('editProductCd').value = '';
				document.getElementById('editProductName').value = '';
				document.getElementById('editPrice').value = '';
				return;
			}

			// 他のチェックを解除
			document.querySelectorAll('input[name="productId"]').forEach(c => c.checked = false);

			// 選択
			checkbox.checked = true;

			// 編集フォームに反映
			document.getElementById('editProductId').value = checkbox.value;
			document.getElementById('editProductCd').value = row.cells[1].innerText;
			document.getElementById('editProductName').value = row.cells[2].innerText;
			document.getElementById('editPrice').value = row.cells[4].innerText;
		}

		function submitReceive() {
			const product = getCheckedProduct();
			if (!product) return;

			const qty = document.getElementById('receiveQty').value;
			if (!qty || qty <= 0) {
				alert('数量を入力してください');
				return;
			}

			document.getElementById('formProductId').value = product.value;
			document.getElementById('formQuantity').value = qty;
			document.getElementById('receiveForm').submit();
		}

		function submitShip() {
			const product = getCheckedProduct();
			if (!product) return;

			const qty = parseInt(document.getElementById('shipQty').value);
			if (!qty || qty <= 0) {
				alert('数量を入力してください');
				return;
			}

			const stock = parseInt(product.closest('tr').querySelector('.num').innerText);
			if (qty > stock) {
				alert('在庫が足りません');
				return;
			}

			document.getElementById('formShipProductId').value = product.value;
			document.getElementById('formShipQuantity').value = qty;
			document.getElementById('shipForm').submit();
		}
	</script>

</body>
</html>
